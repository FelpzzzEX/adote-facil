describe('Cadastro de Animal para Adoção', () => {
  const base = 'http://localhost:3000';
  const urlCadastroAnimal = `${base}/area_logada/disponibilizar_animal`;

  // Garante que o handler de exceção está presente para ignorar
  // erros não críticos da aplicação React.
  Cypress.on('uncaught:exception', (err, runnable) => {
    if (err.message.includes('Minified React error #418')) {
      return false;
    }
    return true;
  });

  beforeEach(() => {
    cy.session('usuario-logado-final', () => {
      cy.visit(`${base}/login`);
      cy.get('input[name="email"]').type('maria@mail.com');
      cy.get('input[name="password"]').type('12345678');
      cy.get('button[type="submit"]').click();
      cy.url({ timeout: 10000 }).should('include', '/area_logada');
    });

    cy.visit(urlCadastroAnimal);
    // Espera robusta: aguarda que o campo "nome" esteja visível e habilitado.
    cy.get('input[name="name"]', { timeout: 10000 }).should('be.visible').and('be.enabled');
  });

  it('Deve permitir o cadastro completo de um animal (Cenário Principal)', () => {
    cy.on('window:alert', (text) => {
      expect(text).to.equal('Animal cadastrado com sucesso!');
    });

    //Comandos separados para evitar o erro de re-renderização do React.
    cy.get('input[name="name"]').clear();
    cy.get('input[name="name"]').type('Flynn');

    cy.get('input[name="race"]').clear();
    cy.get('input[name="race"]').type('SRD'); 

    cy.get('textarea[name="description"]').clear();
    cy.get('textarea[name="description"]').type('Muito dócil e adora crianças.');

    cy.get('[role="combobox"]').eq(0).click();
    cy.get('[role="option"]', { timeout: 5000 }).contains('Gato').click();

    cy.get('[role="combobox"]').eq(1).click();
    cy.get('[role="option"]', { timeout: 5000 }).contains('Macho').click();
    
    // Upload do arquivo
    cy.get('input[type="file"]').attachFile('gato.png');
        cy.get('button[type="submit"]').click();

    // Verificação final: Garante que o redirecionamento ocorreu após o alerta.
    cy.url({ timeout: 10000 }).should('include', '/area_logada/meus_animais');
  });

  it('Não deve permitir o cadastro se os campos obrigatórios não forem preenchidos (Variação 1)', () => {
    // Apenas tenta submeter o formulário sem preencher nada
    cy.get('button[type="submit"]').click();

    cy.contains('O nome é obrigatório').should('be.visible');
    cy.contains('O tipo é obrigatório').should('be.visible');
    cy.contains('O gênero é obrigatório').should('be.visible');
    cy.contains('Adicione ao menos uma foto do animal').should('be.visible');
  });

  it('Deve exibir um aviso ao tentar fazer upload de mais de 5 fotos (Variação 2)', () => {
    // DADO que eu preencho os dados básicos do animal
    cy.get('input[name="name"]').clear();
    cy.get('input[name="name"]').type('Flynn');

    // QUANDO eu tento fazer o upload de 6 fotos (acima do limite de 5)
    const files = ['gato.png', 'f1.png', 'f2.png', 'f3.png', 'f4.png', 'f5.png'];
    cy.get('input[type="file"]').attachFile(files);

    // ENTÃO a mensagem de aviso sobre o limite de fotos deve ser exibida
    cy.contains('Você pode adicionar no máximo 5 fotos!').should('be.visible');

    // E NENHUMA foto deve ter sido adicionada
    cy.get('img[alt="animal picture"]').should('not.exist');
  });
});