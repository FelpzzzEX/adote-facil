# Versão com as melhorias sugeridas
name: Pipeline de CI/CD com Melhorias

on:
  pull_request:
    branches:
      - main

jobs:
  # ANTES: O job se chamava 'unit-test'.
  
  # AGORA: Renomeado para 'unit-test-and-lint' para refletir que agora também verifica o frontend.
  
  # POR QUÊ: Um nome mais descritivo melhora a clareza e a manutenção do pipeline.
  unit-test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      # --- Backend Steps ---
      
      ## MELHORIA 1: Otimização do comando de instalação ##
      
      # ANTES: Usava 'npm install', que pode ser mais lento e menos previsível em ambientes de CI.
      
      # AGORA: Utiliza 'npm ci', o comando padrão-ouro para automação.
      
      # POR QUÊ: 'npm ci' é mais rápido, mais seguro e garante uma instalação 100% consistente baseada no arquivo package-lock.json.
      - name: Instalar dependências do backend com 'npm ci'
        run: |
          cd backend
          npm ci

      - name: Executar testes unitários com Jest
        run: |
          cd backend
          npm test -- --coverage
      
      ## MELHORIA 2: Adição da verificação de qualidade do frontend ##
      
      # ANTES: O pipeline ignorava completamente o código do frontend. 
      #Não havia nenhum passo para validar sua qualidade ou dependências.
      
      # AGORA: Foram adicionados passos dedicados para instalar as dependências e rodar o linter do frontend.
      
      # POR QUÊ: Garante que o código do frontend também passe por uma verificação automatizada, 
      #prevenindo a integração de erros e mantendo um padrão de código.
      - name: Instalar dependências do frontend com 'npm ci'
        run: |
          cd frontend
          npm ci

      - name: Executar Linter do frontend
        run: |
          cd frontend
          npm run lint

  build:
    needs: unit-test-and-lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      # Uma melhoria bônus : Atualização de versões das actions
      
      # ANTES: Notamos que algumas actions usavam versões mais antigas (@v2).
      
      # AGORA: Atualizadas para versões mais recentes (@v3, @v4) para ter as últimas funcionalidades e 
      #correções de segurança.
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Configurar Docker QEMU
        uses: docker/setup-qemu-action@v2
      - name: Build das imagens Docker
        run: docker compose build

  up-containers:
    needs: build
    runs-on: ubuntu-latest
    env:
      POSTGRES_DB: adote_facil
      POSTGRES_HOST: adote-facil-postgres
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_PORT: 5432
      POSTGRES_CONTAINER_PORT: 6500
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
      - name: Criar arquivo .env
        working-directory: ./backend
        run: |
          echo "POSTGRES_DB=${{ env.POSTGRES_DB }}" > .env
          echo "POSTGRES_HOST=${{ env.POSTGRES_HOST }}" >> .env
          echo "POSTGRES_USER=${{ env.POSTGRES_USER }}" >> .env
          echo "POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_PORT=${{ env.POSTGRES_PORT }}" >> .env
          echo "POSTGRES_CONTAINER_PORT=${{ env.POSTGRES_CONTAINER_PORT }}" >> .env

      ## MELHORIA 3: Teste de inicialização mais confiável ##
      
      # ANTES: O job subia os containers, esperava 10 segundos cegamente ('sleep 10') e os desligava, 
      #sem nenhuma verificação real se os serviços funcionaram.
      
      # AGORA: O tempo de espera foi aumentado para 15s e, crucialmente, 
      #um comando 'docker compose logs' foi adicionado.
      
      # POR QUÊ: Verificar os logs é uma forma simples e eficaz de confirmar se os 
      #serviços iniciaram sem erros críticos. Isso torna o teste muito mais útil e informativo do que apenas esperar.
      - name: Subir e verificar logs dos containers
        run: |
          docker compose up -d
          echo "Aguardando 15 segundos para a inicialização dos serviços..."
          sleep 15
          echo "Exibindo logs dos containers para verificação de erros:"
          docker compose logs
          echo "Desligando os containers..."
          docker compose down

  delivery:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
      - name: Gerar arquivo ZIP do projeto completo
        run: zip -r adote-facil-projeto.zip . -x '.git' '.github' '*/node_modules/'
      - name: Upload do artefato
        uses: actions/upload-artifact@v4
        with:
          name: adote-facil-projeto
          path: adote-facil-projeto.zip
